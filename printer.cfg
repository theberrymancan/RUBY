#####################################################################
#########################  INCLUDES  ################################
#####################################################################

[include AFC/*.cfg]
[include mainsail.cfg]
[include fan_tach_monitor.cfg]
[include KAMP_Settings.cfg]
[include shell_command.cfg]
[include config_backup.cfg]
[include goose_belt.cfg]

[pause_resume]
[exclude_object]
[firmware_retraction]
[skew_correction]
[axis_twist_compensation]

[virtual_sdcard]
path: /home/alexberryman/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[gcode_arcs]
resolution: 0.1               

[force_move]
enable_force_move: true


#####################################################################
#########################  Kinematics  ##############################
#####################################################################

[printer]
kinematics: corexy
max_velocity: 600
max_accel: 10000
max_z_velocity: 50
max_z_accel: 100
minimum_cruise_ratio: 0.5
square_corner_velocity: 25


#####################################################################
################  MCU (MANTA M8P v2) Config  ########################
#####################################################################

[mcu]
canbus_uuid: 20e9829176f6
canbus_interface: can0


#####################################################################
################  Toolhead (EBB36 v1.2) Config  #####################
#####################################################################

[mcu EBB36]
canbus_uuid: 1c49b2dd7186 


#####################################################################
##############   MCU Cartographer v3 (ADXL345)   ####################
#####################################################################

[mcu cartographer]
canbus_uuid: 3dcd961df308

[cartographer]
mcu: cartographer
x_offset: 0
y_offset: 21   

[adxl345]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345
probe_points:
    175, 175, 20

[axis_twist_compensation]
speed: 50
horizontal_move_z: 10
calibrate_start_x: 10
calibrate_end_x: 340
calibrate_y: 175

[bed_mesh]
zero_reference_position: 175,175
speed: 200
horizontal_move_z: 5
mesh_min: 30, 30
mesh_max: 320, 320
probe_count: 30, 30
algorithm: bicubic


#####################################################################
###################   Temperature Monitoring   ######################
#####################################################################

[temperature_sensor CM5]
sensor_type: temperature_host
min_temp: 0
max_temp: 85

[temperature_sensor MANTA]    
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 0
max_temp: 85

[temperature_sensor EBB36]
sensor_type: temperature_mcu
sensor_mcu: EBB36
min_temp: 0
max_temp: 85

[temperature_sensor Cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105

[temperature_sensor CHAMBER]
sensor_type: Generic 3950
sensor_pin: PB0
min_temp: 0
max_temp: 85


#####################################################################
##########################  Extruder  ###############################
#####################################################################

[extruder]
step_pin: EBB36: PD0
dir_pin: !EBB36: PD1
enable_pin: !EBB36: PD2
full_steps_per_rotation: 200
microsteps: 16
gear_ratio: 50:8
rotation_distance: 22.4224
nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_only_velocity: 130
max_extrude_only_accel: 3000
max_extrude_only_distance: 400
max_extrude_cross_section: 50
heater_pin: EBB36: PB13
#control: pid
#pid_Kp: 24.328
#pid_Ki: 1.908
#pid_Kd: 77.543
min_temp: -20
max_temp: 350
min_extrude_temp: 170
pressure_advance: 0.05
pressure_advance_smooth_time: 0.040
sensor_type:MAX31865
sensor_pin: EBB36: PA4
spi_bus: spi1
rtd_nominal_r: 1000
rtd_reference_r: 4300
rtd_num_of_wires: 2

[tmc2209 extruder]
uart_pin: EBB36: PA15
interpolate: true
run_current: 0.60

[verify_heater extruder]
max_error: 120
check_gain_time: 120
hysteresis: 50
heating_gain: 2


#####################################################################
#############################  X Axis  ##############################
#####################################################################

[stepper_x]
# Front Left stepper motor
step_pin: PE6
dir_pin: !PE5
enable_pin: !PC14
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: EBB36: PB8
position_min: 0
position_endstop: 350
position_max: 350
homing_speed: 80
homing_retract_dist: 5
homing_positive_dir: true

[tmc5160 stepper_x]
cs_pin: PC13
spi_software_sclk_pin: PG8
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
driver_TPFD: 0
run_current: 1.5
spi_speed: 3500000
interpolate: True
stealthchop_threshold: 0

[stepper_x1]
#Rear Right stepper motor
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200

[tmc5160 stepper_x1]
cs_pin: PD5
spi_software_sclk_pin: PG8
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
driver_TPFD: 0
run_current: 1.5
spi_speed: 3500000
interpolate: True
stealthchop_threshold: 0


#####################################################################
#############################  Y Axis  ##############################
#####################################################################

[stepper_y]
#Front Right stepper motor
step_pin: PC7
dir_pin: !PC8
enable_pin: !PD2
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: PF2
position_min: 0
position_endstop: 360
position_max: 360
homing_speed: 80
homing_retract_dist: 5
homing_positive_dir: true

[tmc5160 stepper_y]
cs_pin: PC6
spi_software_sclk_pin: PG8
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
driver_TPFD: 0
run_current: 1.5
spi_speed: 3500000
interpolate: True
stealthchop_threshold: 0

[stepper_y1]
#Rear Left stepper motor
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE4
microsteps: 32
rotation_distance: 40
full_steps_per_rotation: 200

[tmc5160 stepper_y1]
cs_pin: PE3
spi_software_sclk_pin: PG8
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
driver_TPFD: 0
run_current: 1.5
spi_speed: 3500000
interpolate: True
stealthchop_threshold: 0


#####################################################################
#############################  Z Axis  ##############################
#####################################################################
#    -------z1------- 
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#   |                 |
#  z0---   display ---z2
#####################################################################
#####################################################################
#####################################################################

[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
microsteps: 16
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
position_max: 230
position_min: -10.00
homing_speed: 20
homing_retract_dist: 0
homing_positive_dir: False


#--------------------------------------------------------------------
[tmc2209 stepper_z]
uart_pin: PB9
interpolate: true
run_current: 0.8
hold_current: 0.8

#--------------------------------------------------------------------
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 16
rotation_distance: 4

#--------------------------------------------------------------------
[tmc2209 stepper_z1]
uart_pin: PB5
interpolate: true
run_current: 0.8
hold_current: 0.8

#--------------------------------------------------------------------
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 16
rotation_distance: 4

#--------------------------------------------------------------------
[tmc2209 stepper_z2]
uart_pin: PG14
interpolate: true
run_current: 0.8
hold_current: 0.8


#####################################################################
########################   Heated Bed   #############################
#####################################################################

[heater_bed]
heater_pin: PA1
sensor_pin: PB1
sensor_type: ATC Semitec 104GT-2
#control: pid
#pid_kp: 53.467
#pid_ki: 0.931
#pid_kd: 767.921
min_temp: -20
max_temp: 125
max_power: 1.0

[idle_timeout]
timeout: 3600


#####################################################################
############################  Fans  #################################
#####################################################################

[heater_fan hotend_fan]               # Delta 2510 5V 3-Wire Axial Fan ASB02505SHA-AY6B
pin: EBB36: PA1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
tachometer_pin: ^EBB36: PB9
tachometer_ppr: 2
tachometer_poll_interval: 0.0005
fan_speed: 0.8
cycle_time: 0.00003

#--------------------------------------------------------------------

[temperature_fan electronics_fan]    # 2 GDSTime GDA6020 24v Dual Ball Bearing Fans       
pin: PF9
max_power: 1.0
shutdown_speed: 1.0
cycle_time: 0.00003
hardware_pwm: False
kick_start_time: 0.5
sensor_type: temperature_combined
sensor_list: temperature_sensor MANTA, temperature_sensor CM5
combination_method: max
maximum_deviation: 999.9
max_temp: 85
min_temp: 0
target_temp: 40.0
max_speed: 1.0
min_speed: 1.0
control: watermark
max_delta: 5
min_temp: 0
max_temp: 85
target_temp: 40.0

#--------------------------------------------------------------------

[controller_fan driver_fan]        # Stepper Driver Cooling - 2 Siboor 24v 4010 Axial Fans
pin: PA4
cycle_time: 0.00003
max_power: 1.0
shutdown_speed: 1.0
fan_speed: 1.0
idle_timeout: 90
idle_speed: 0.4
stepper: stepper_x

#--------------------------------------------------------------------

[fan]                               # 2 GDSTime 24v 4010 12k RPM Part Cooling Fans
pin: EBB36: PA0
max_power: 1.0
shutdown_speed: 0.0
cycle_time: 0.010
hardware_pwm: false
kick_start_time: 0.5
off_below: 0.0

#--------------------------------------------------------------------

[fan_generic fan3]                 # Fume_Pack Exhaust Fan - 2 Siboor 24v 5015 Blower Fans
pin: PF7
cycle_time: 0.00003
hardware_pwm: false
kick_start_time: 0.5

#--------------------------------------------------------------------

[fan_generic BED_FANS]             # 4 GDSTime 24v 5015 Blower Fans
pin: PF8
max_power: 1.0
shutdown_speed: 0
cycle_time: 0.010
hardware_pwm: false
kick_start_time: 0.1

#--------------------------------------------------------------------

[gcode_macro M109]
rename_existing: M99109
gcode:
    #Parameters
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}   # Wait for hotend temp (within 1 degree)
    {% endif %}

    
#####################################################################
############################  LEDs  #################################
#####################################################################

[neopixel hotend_led]
pin: EBB36: PD3                # LED pin
chain_count: 3                 # Number of LEDs
color_order: GRB               # Color order
initial_RED: 1.0               # Initial red brightness
initial_GREEN: 1.0             # Initial green brightness
initial_BLUE: 1.0              # Initial blue brightness


#######################################################################
######################  Homing Override  ##############################
#######################################################################

[homing_override]
axes: xyz                   # Override homing for all axes
set_position_z: 0           # Set the Z position to 0 after homing
gcode:
    G90                     # Set to absolute positioning mode
    G0 Z10 F1200            # Move Z axis to 10mm above the bed at 1200 mm/min
    G28 X                   # Home X axis
    G1 X250 F7200           # Move X to clear rear motor before homing
    G28 Y                   # Home Y axis
    G1 X175 Y175 F7200      # Move to a specific coordinate (175, 175) at 7200 mm/min
    G28 Z                   # Home Z axis again
    

#######################################################################
######################  Z Tilt Adjustment  ############################
#######################################################################

[z_tilt]
##  Use Z_TILT_ADJUST to level the bed.
##  z_positions: Location of toolhead
z_positions:
   -50, 18
   175, 398
   400, 18
points:
   50, 50
   175, 300
   300, 50

#---------------------------------------------------------------------

speed: 350                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy

#---------------------------------------------------------------------

[gcode_macro Z_TILT_ADJUST]     # IDM/Cartographer optimized 3Z leveling macro
rename_existing: _Z_TILT_ADJUST
gcode:
    SAVE_GCODE_STATE NAME=STATE_Z_TILT         # Save current state for Z tilt adjustment
    BED_MESH_CLEAR                             # Clear bed mesh
    {% if not printer.z_tilt.applied %}
      _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1   # Adjust Z tilt with higher tolerance initially
    {% endif %}
    _Z_TILT_ADJUST horizontal_move_z=2          # Fine-tune Z tilt adjustment
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT       # Restore saved state after adjustment
    CENTER                                      # Move toolhead to center of build plate.


#######################################################################
######################  Convenience Macros  ###########################
#######################################################################

[gcode_macro PID_CALIBRATE_HOTEND]
description: Hotend Pid Calibrate
gcode:
  {% if printer.print_stats.state != "printing" %}
    PID_CALIBRATE HEATER=extruder TARGET={params.HOTEND_TEMP|default(230)}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}

[gcode_macro PID_CALIBRATE_BED]
description: Bed Pid Calibrate
gcode:
  {% if printer.print_stats.state != "printing" %}
    PID_CALIBRATE HEATER=heater_bed TARGET={params.BED_TEMP|default(65)}
  {% else %}
    RESPOND TYPE=error MSG='Not available while printing'
  {% endif %}

[gcode_macro CENTER]
description: Defines a G-code macro for centering the toolhead.
gcode:
    G90                           # Set absolute positioning.
    G0 X175 Y175 Z30 F18000       # Fast move to center position 30mm above bed.

[gcode_macro QUICK_NOZZLE_BRUSH]
description: for quick cleaning from the home screen, centers toolhead after brushing.
gcode:
   SAVE_GCODE_STATE NAME=quick_nozzle_brush
   G90
   G1 X95 F18000
   G1 Y355 F18000
   G1 X125 F18000
   G1 X95 F18000
   G1 X125 F18000
   G1 X95 F18000
   G1 X125 F18000
   G1 Y355 F18000
   G1 X95 F18000
   G1 X125 F18000
   CENTER
   RESTORE_GCODE_STATE NAME=quick_nozzle_brush

[shaketune]
result_folder: ~/printer_data/config/ShakeTune
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allows Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
measurements_chunk_size: 10
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.
    

#######################################################################
###################  Probe Calibration Macro  #########################
#######################################################################

[gcode_macro PROBE_CALIBRATE]
# Defines a G-code macro for probe calibration
gcode:
    G28                          # Home all axes
    G0 X175 Y175 Z1 F3600        # Fast move to X150 Y150 Z1 at 3600 mm/min
    PROBE_CALIBRATE              # Start probe calibration
    

#######################################################################
###########  Bed Leveling Height and Calibration Macro  ###############
#######################################################################

[gcode_macro G32]
# Defines a G-code macro for bed leveling and height calibration
gcode:
    BED_MESH_CLEAR               # Clear bed mesh
    G28                          # Home all axes
    Z_TILT_ADJUST                # Perform gantry leveling
    G28                          # Home all axes
    G0 X175 Y175 Z30 F3600       # Fast move to center position 30mm above bed

#---------------------------------------------------------------------

[gcode_macro DRAW_LINES]
gcode:
    G90                           # Absolute positioning
    # G92 E0                      # Reset Extruder (commented out for now)
    # G1 Z5.0  F7200              # Move Z Axis up (commented out for now)
    G1 X50  Y0         F7200      # Move to start position
    M83                           # Set extruder to relative mode
    G1 E15 F400                   # Extrude filament
    G1 Z0.28 F7200                # Lower Z axis
    G1 X200 Y0   Z0.28 F1200 E17  # Draw the first line
    G1 X200 Y0.4 Z0.28 F2400      # Move to side a little
    G1 X55  Y0.4 Z0.28 F1200 E34  # Draw the second line
    G92 E0                        # Reset Extruder
    G90                           # Return to absolute positioning


#######################################################################
###################  Print Start and End Macros  ######################
#######################################################################

[gcode_macro PRINT_START]
gcode:
  {% set target_bed = params.BED|int %}                         # Target bed temperature
  {% set target_extruder = params.EXTRUDER|int %}               # Target nozzle temperature
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}  # Bed center X
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}  # Bed center Y
  {% set initial_tool = params.TOOL|default("0")|int %}         # Checks that correct initial color is loaded.

  M104 S150                                                     # Preheat nozzle to 150C to avoid oozing before z-offset adjustment
  M107                                                          # initiate fan control
  SET_FAN_SPEED FAN=BED_FANS SPEED=0.5                          # set bed fans to 50%
  SET_FAN_SPEED FAN=fan3 SPEED=0.5                              # set filter fan to 50%
  M106 S0                                                       # set part cooling fans to 0%

  SET_GCODE_OFFSET Z=0                                          # Reset Z offset
  G28                                                           # Home all axes
  G90                                                           # Set to absolute positioning

  SET_DISPLAY_TEXT MSG="Heating Bed: {target_bed}°C"            # Display bed heating message
  G1 X{x_wait} Y{y_wait} Z15 F9000                              # Move to bed center
  M190 S{target_bed}                                            # Wait for bed to reach target temperature

  SET_DISPLAY_TEXT MSG="Leveling..."                            # Display leveling message
  Z_TILT_ADJUST                                                 # Perform Z tilt adjustment
  G28 Z                                                         # Re-home Z after adjustment

  SET_DISPLAY_TEXT MSG="Bed Mesh Calibration"                   # Display mesh calibration message
  BED_MESH_CALIBRATE                                            # Perform bed mesh calibration (KAMP)

  SET_DISPLAY_TEXT MSG="Calibrating Z Offset"                   # Display Z offset calibration message
  AFC_BRUSH                                                     # Clear debris from nozzle before nozzle offset calibration.
  CARTOGRAPHER_TOUCH                                            # Calibrate Z offset
  
  SET_DISPLAY_TEXT MSG="Heating Nozzle: {target_extruder}°C"    # Display nozzle heating message
  M109 S{target_extruder}                                       # Heat nozzle to target temperature

  SET_DISPLAY_TEXT MSG="Preparing to Print..."                  # Display preparation message
  GOOSE_PURGE PURGE_LENGTH=120                                  # Initiates purge on Goose Belt Purger
  
  SKEW_PROFILE LOAD=my_skew_profile	                            # Loads skew profile right before printing begins. 

#--------------------------------------------------------------------

[gcode_macro PRINT_END]
gcode:
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 15, th.axis_maximum.z]|min %}

    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150              # sets heaters to idle position to maintain chamber temperature
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=110            # sets heaters to idle position to maintain chamber temperature
    M107                                                           # initiate fan control
    SET_FAN_SPEED FAN=BED_FANS SPEED=0.5                           # set bed fans to 50%
    SET_FAN_SPEED FAN=fan3 SPEED=0.5                               # set filter fan to 50%
    M106 S0                                                        # set part cooling fans to 0%
    SET_IDLE_TIMEOUT TIMEOUT=3600                                  # sets timeout to 1 hour
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                                                           # wait for buffer to clear
    G92 E0                                                         # zero the extruder
    G1 E-20.0 F3600                                                # retract filament
    
    G90                                                            # absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000                        # move nozzle to remove stringing
    G0 X230 Y330 F3600                                             # move toolhead to safe parking spot to avoid collisions when homing next print

    BED_MESH_CLEAR                                                 # clears bed mesh profile
    SET_SKEW CLEAR=1                                               # clears skew profile

    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0                # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
                                                                   # command pair is to restore the printer's coordinate system
                                                                   # and speed settings since the commands above change them.
                                                                   # However, to prevent any accidental, unintentional toolhead
                                                                   # moves when restoring the state, explicitly set MOVE=0.
    
    
#######################################################################
###################  Pause/Resume/Cancel Macros  ######################
#######################################################################

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    # Parameters
    {% set z = params.Z|default(10)|int %}                                                   # z hop amount

    {% if printer['pause_resume'].is_paused|int == 0 %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              # set z hop variable for reference in resume macro
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    # set hotend temp variable for reference in resume macro

        SAVE_GCODE_STATE NAME=PAUSE                                                          # save current print position for resume
        BASE_PAUSE                                                                           # pause print
        {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       # check that zhop doesn't exceed z max
            G91                                                                              # relative positioning
            G1 Z{z} F900                                                                     # raise Z up by z hop amount
        {% else %}
            { action_respond_info("Pause zhop exceeds maximum Z height.") }                  # if z max is exceeded, show message and set zhop value for resume to 0
            SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
        {% endif %}
        G90                                                                                  # absolute positioning
        G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000   # park toolhead at front center
        SAVE_GCODE_STATE NAME=PAUSEPARK                                                      # save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)
        M104 S0                                                                              # turn off hotend
        SET_IDLE_TIMEOUT TIMEOUT=43200                                                       # set timeout to 12 hours
    {% endif %}

#--------------------------------------------------------------------

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
    # Parameters
    {% set e = params.E|default(2.5)|int %}                                          # hotend prime amount (in mm)

    {% if printer['pause_resume'].is_paused|int == 1 %}
        SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}  # set timeout back to configured value
        {% if etemp > 0 %}
            M109 S{etemp|int}                                                        # wait for hotend to heat back up
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100                     # go back to parked position in case toolhead was moved during pause (otherwise the return zhop can error)
        G91                                                                          # relative positioning
        M83                                                                          # relative extruder positioning
        {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
            G1 Z{zhop * -1} E{e} F900                                                # prime nozzle by E, lower Z back down
        {% else %}
            G1 Z{zhop * -1} F900                                                     # lower Z back down without priming (just in case we are testing the macro with cold hotend)
        {% endif %}
        RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60                          # restore position
        BASE_RESUME                                                                  # resume print
    {% endif %}
  
#--------------------------------------------------------------------

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} ; set timeout back to configured value
    CLEAR_PAUSE
    PRINT_END
    BASE_CANCEL_PRINT

#--------------------------------------------------------------------

[gcode_macro M600]
gcode:
    PAUSE

#--------------------------------------------------------------------

[gcode_macro DATA_SAMPLE]
gcode:
  G90
  M106 S255
  RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
  M117 Waiting for Coil to cool to 40
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40
  RESPOND TYPE=command MSG='Starting Phase 1 of 4'
  M117 Starting Phase 1 of 4
  M106 S0
  G28
  G0 Z1
  M104 S250
  M140 S110
  G4 P1000
  CARTOGRAPHER_STREAM FILENAME=data1
  M117 Waiting for Coil to heat to 70
  RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
  CARTOGRAPHER_STREAM FILENAME=data1
  M104 S0
  M140 S0
  M106 S255
  G0 Z80
  RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
  M117 Waiting for Coil to cool to 40
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40

  M117 Starting Phase 2 of 4
  RESPOND TYPE=command MSG='Starting Phase 2 of 4'
  M106 S0
  G28 Z0
  G0 Z2
  M104 S250
  M140 S110
  G4 P1000
  CARTOGRAPHER_STREAM FILENAME=data2
  M117 Waiting for Coil to heat to 70
  RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
  CARTOGRAPHER_STREAM FILENAME=data2
  M104 S0
  M140 S0
  M106 S255
  G0 Z80
  RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
  M117 Waiting for Coil to cool to 40
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40

  M117 "Starting Phase 3 of 4"
  RESPOND TYPE=command MSG='Starting Phase 3 of 4'
  M106 S0
  G28 Z0
  G0 Z3
  M104 S250
  M140 S110
  G4 P1000
  CARTOGRAPHER_STREAM FILENAME=data3
  M117 Waiting for Coil to heat to 70
  RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
  CARTOGRAPHER_STREAM FILENAME=data3
  M104 S0
  M140 S0
  M106 S255
  G0 Z80
  M117 Waiting for Coil to cool to 40
  RESPOND TYPE=command MSG='Waiting for Coil to cool to 40'
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MAXIMUM=40

  M117 "Starting Phase 4 of 4"
  RESPOND TYPE=command MSG='Starting Phase 4 of 4'
  M106 S0
  G28 Z0
  G0 Z5
  M104 S250
  M140 S110
  G4 P1000
  CARTOGRAPHER_STREAM FILENAME=data4
  M117 Waiting for Coil to heat to 70
  RESPOND TYPE=command MSG='Waiting for Coil to heat to 70'
  TEMPERATURE_WAIT SENSOR='temperature_sensor cartographer_coil' MINIMUM=55
  CARTOGRAPHER_STREAM FILENAME=data4
  M104 S0
  M140 S0
  RESPOND TYPE=command MSG='Testing complete, please move files using: mv ~/klipper/data1 ~/klipper/data2 ~/klipper/data3 ~/klipper/data4 ~/cartographer-klipper/'
  M117 "Testing complete, please move files using: mv ~/klipper/data1 ~/klipper/data2 ~/klipper/data3 ~/klipper/data4 ~/cartographer-klipper/"
  RESPOND TYPE=command MSG='Follow the remaining instructions here: https://docs.cartographer3d.com/cartographer-probe/advanced-features/temperature-differential-calibration-beta'
  M117 "Follow the remaining instructions here: https://docs.cartographer3d.com/cartographer-probe/advanced-features/temperature-differential-calibration-beta"


#######################################################################
########################  Speed Test Macro  ###########################
#######################################################################

[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x %}
        {% if x_min < 0 %}
            {% set x_min = 0 %}
        {% endif %}
    
        {% set y_min = printer.toolhead.axis_minimum.y %}
        {% if y_min < 0 %}
            {% set y_min = 0 %}
        {% endif %}
    
        {% set x_min = x_min + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = y_min + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 57.946
#*# pid_ki = 3.449
#*# pid_kd = 243.371
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.043
#*# pid_ki = 5.158
#*# pid_kd = 56.170
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.042470, 0.036470, 0.032496, 0.028331, 0.018820, 0.006971, -0.003995, 0.007569, 0.012466, 0.022782, 0.033184, 0.046325, 0.056067
#*# 	0.043611, 0.041603, 0.036221, 0.030858, 0.021489, 0.008221, -0.000117, 0.008815, 0.015152, 0.025436, 0.035197, 0.046482, 0.057775
#*# 	0.042218, 0.038781, 0.035096, 0.029902, 0.019861, 0.010065, 0.000171, 0.007947, 0.017202, 0.025838, 0.036661, 0.049630, 0.061254
#*# 	0.039300, 0.035875, 0.031250, 0.026396, 0.017625, 0.005746, -0.001974, 0.004986, 0.013425, 0.023979, 0.035536, 0.047782, 0.060093
#*# 	0.038839, 0.036149, 0.031400, 0.026832, 0.018531, 0.008887, -0.000117, 0.004940, 0.015839, 0.025661, 0.038904, 0.052828, 0.064025
#*# 	0.041677, 0.038654, 0.033449, 0.028729, 0.021397, 0.013067, 0.001403, 0.009586, 0.018150, 0.030365, 0.043398, 0.057117, 0.069276
#*# 	0.042266, 0.040429, 0.037178, 0.032205, 0.026152, 0.016860, 0.008004, 0.015705, 0.027595, 0.038630, 0.051905, 0.066334, 0.079174
#*# 	0.042809, 0.041720, 0.038730, 0.035488, 0.030545, 0.022246, 0.014321, 0.024085, 0.034366, 0.047321, 0.060751, 0.075168, 0.089133
#*# 	0.039696, 0.037414, 0.035829, 0.032914, 0.028164, 0.021819, 0.015753, 0.025828, 0.036631, 0.049200, 0.064187, 0.077139, 0.090663
#*# x_count = 13
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 115.199
#*# max_x = 234.449
#*# min_y = 140.022
#*# max_y = 210.229
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 89.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 78.0
#*#
#*# [skew_correction my_skew_profile]
#*# xy_skew = 8.485356890334648e-05
#*# xz_skew = 0.0017677840683366333
#*# yz_skew = -0.0017465585107267515
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.4356107729357708,1.9163020726463973,0.8680387773656999,0.4471047540529253,0.4149875633917497,0.3778369046812787,-0.18981921918358566,-0.2902075450630308,0.27215225749834887,0.25171530016072613
#*# domain = 3.169265999926063e-07,3.305376106205369e-07
#*# z_offset = 0
#*# reference_temperature = 23.32
#*# software_version = 1.4.0
#*# mcu_version = CARTOGRAPHER 5.0.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 1541
#*# speed = 2
#*# z_offset = -0.05
#*# software_version = 1.4.0
#*# mcu_version = CARTOGRAPHER 5.0.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.128043, -0.082475, -0.045568
#*# compensation_start_x = 10.0
#*# compensation_end_x = 340.0
